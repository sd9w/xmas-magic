<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Magic Christmas 2024 (Lite)</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: sans-serif; touch-action: none; }
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, #1a1a1a 0%, #000 100%);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 100; color: #FFD700; transition: opacity 0.5s;
        }
        #start-btn {
            padding: 15px 40px; font-size: 1.2rem; background: rgba(255,215,0,0.1);
            border: 2px solid #FFD700; color: #FFD700; border-radius: 30px;
            cursor: pointer; box-shadow: 0 0 20px rgba(255,215,0,0.3);
            -webkit-tap-highlight-color: transparent;
        }
        #status-pill {
            position: absolute; top: 40px; left: 50%; transform: translateX(-50%);
            padding: 8px 16px; background: rgba(0,0,0,0.5); border-radius: 20px;
            color: #FFD700; font-size: 13px; z-index: 10; backdrop-filter: blur(5px);
            border: 1px solid rgba(255,215,0,0.2);
            white-space: nowrap;
        }
        #christmas-text {
            position: absolute; top: 25%; left: 50%; transform: translate(-50%, -50%);
            font-size: 3rem; font-weight: 900; color: #FFD700; z-index: 5;
            text-shadow: 0 0 30px #FFD700; opacity: 0; pointer-events: none;
            transition: opacity 0.3s;
            text-align: center;
        }
        #video-input { position: absolute; width: 1px; height: 1px; opacity: 0; pointer-events: none; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <div id="overlay">
        <h1 style="font-size: 2rem; margin-bottom: 10px;">åœ£è¯æ‰‹åŠ¿é­”æ³•</h1>
        <p style="opacity: 0.8; margin-bottom: 30px;">æ€§èƒ½ä¼˜åŒ–ç‰ˆ</p>
        <button id="start-btn">å¼€å¯é­”æ³•</button>
    </div>

    <div id="status-pill">ğŸ“¡ å‡†å¤‡å°±ç»ª</div>
    <h1 id="christmas-text">MERRY<br>CHRISTMAS</h1>
    <video id="video-input" playsinline webkit-playsinline></video>
    <div id="canvas-container"></div>

<script>
    // --- é’ˆå¯¹æ‰‹æœºçš„æ€§èƒ½é…ç½® ---
    const isMobile = window.innerWidth < 768;
    const CONFIG = {
        // æ‰‹æœºä¸Šå¤§å¹…å‡å°‘ç²’å­æ•°ï¼Œé˜²æ­¢å´©æºƒ
        pCount: isMobile ? 1200 : 5000, 
        videoW: isMobile ? 360 : 640,
        videoH: isMobile ? 270 : 480
    };

    let scene, camera, renderer, giftTree, star, particles, clock = new THREE.Clock();
    let openness = 0, curOpen = 0;
    let cameraInstance = null;

    document.getElementById('start-btn').onclick = function() {
        const btn = this;
        btn.innerText = "åŠ è½½ä¸­...";
        btn.disabled = true;

        setTimeout(() => {
            document.getElementById('overlay').style.opacity = '0';
            setTimeout(() => document.getElementById('overlay').style.display = 'none', 500);
            
            initThree();
            startAI(); 
            animate();
        }, 100);
    };

    function initThree() {
        scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000000, 0.04);

        camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 500);
        camera.position.set(0, 6, 22);

        renderer = new THREE.WebGLRenderer({ antialias: !isMobile, powerPreference: "high-performance" });
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // é™åˆ¶DPR
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // ç®€åŒ–ç¯å…‰
        const amb = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(amb);
        
        // åªæœ‰éç§»åŠ¨ç«¯æ‰å¼€ç‚¹å…‰æºé˜´å½±è®¡ç®—
        const point = new THREE.PointLight(0xffd700, 1.5, 40);
        point.position.set(0, 10, 5);
        scene.add(point);

        createTree();
        createParticles();
    }

    function createTree() {
        giftTree = new THREE.Group();
        // å‡å°‘æè´¨åˆ‡æ¢å¼€é”€
        const geom = new THREE.BoxGeometry(0.9, 0.9, 0.9);
        const mat = new THREE.MeshStandardMaterial({ 
            color: 0x228b22, 
            roughness: 0.4, 
            metalness: 0.1 
        });
        
        // å‡å°‘ç›’å­æ•°é‡
        const levels = isMobile ? 8 : 12;
        
        for(let i=0; i<levels; i++) {
            const h = i * 0.9;
            const rad = 5 * (1 - i/levels) + 0.2;
            const count = Math.floor(rad * 3.5) + 2; 
            for(let j=0; j<count; j++) {
                const ang = (j/count) * Math.PI * 2 + i;
                const box = new THREE.Mesh(geom, mat);
                
                // éšæœºé¢œè‰²ä¼˜åŒ–
                if(Math.random() > 0.7) {
                    box.material = mat.clone();
                    box.material.color.setHex(Math.random() > 0.5 ? 0xff0000 : 0xffd700);
                }
                
                box.position.set(Math.cos(ang)*rad, h, Math.sin(ang)*rad);
                box.rotation.set(Math.random(), ang, 0);
                box.scale.setScalar(0.6 * (1-i/15));
                giftTree.add(box);
            }
        }

        const sGeo = new THREE.OctahedronGeometry(1, 0);
        const sMat = new THREE.MeshBasicMaterial({ color: 0xfff000 });
        star = new THREE.Mesh(sGeo, sMat);
        star.position.y = levels * 0.9 + 0.5;
        giftTree.add(star);

        giftTree.position.y = -5;
        scene.add(giftTree);
    }

    function createParticles() {
        const geo = new THREE.BufferGeometry();
        const pos = [], vels = [];
        for(let i=0; i<CONFIG.pCount; i++) {
            pos.push((Math.random()-0.5)*60, Math.random()*40, (Math.random()-0.5)*60);
            vels.push(Math.random() * 0.1 + 0.05); // é™ä½é€Ÿåº¦
        }
        geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
        geo.setAttribute('velocity', new THREE.Float32BufferAttribute(vels, 1));
        
        // ä½¿ç”¨æ›´ç®€å•çš„æè´¨
        const mat = new THREE.PointsMaterial({ 
            color: 0xffd700, 
            size: isMobile ? 0.3 : 0.2, // æ‰‹æœºä¸Šç²’å­å°‘ä½†å¤§ä¸€ç‚¹
            transparent: true, 
            opacity: 0.8,
            blending: THREE.AdditiveBlending 
        });
        particles = new THREE.Points(geo, mat);
        scene.add(particles);
    }

    async function startAI() {
        const status = document.getElementById('status-pill');
        
        try {
            const hands = new Hands({
                locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
            });

            // ã€å…³é”®ä¼˜åŒ–ã€‘ä½¿ç”¨ Lite æ¨¡å‹ (modelComplexity: 0) 
            hands.setOptions({ 
                maxNumHands: 1, 
                modelComplexity: 0, 
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            hands.onResults(res => {
                if(res.multiHandLandmarks.length > 0) {
                    status.innerText = "ğŸŒŸ é­”æ³•ç”Ÿæ•ˆä¸­";
                    const lm = res.multiHandLandmarks[0];
                    // ç®€åŒ–è·ç¦»è®¡ç®—ï¼Œåªå– Y è½´å·®å¼‚å¤§æ¦‚ä¼°ç®—ï¼Œå‡å°‘å¼€é”€
                    const d = Math.hypot(lm[4].x-lm[8].x, lm[4].y-lm[8].y);
                    openness = Math.min(1, d * 5);
                } else {
                    status.innerText = "ğŸ‘‹ è¯·å¼ å¼€æ‰‹æŒ";
                    openness = 0;
                }
            });

            const videoElement = document.getElementById('video-input');
            cameraInstance = new Camera(videoElement, {
                onFrame: async () => {
                    await hands.send({image: videoElement});
                },
                width: CONFIG.videoW, // é™ä½åˆ†è¾¨ç‡
                height: CONFIG.videoH,
                facingMode: 'user'
            });

            status.innerText = "âœ¨ æ­£åœ¨å”¤é†’æ˜Ÿå…‰...";
            await cameraInstance.start();
            
        } catch(e) {
            console.error(e);
            status.innerText = "âš ï¸ æ— æ³•å¼€å¯æ‘„åƒå¤´ï¼Œè¯·åœ¨Safari/Chromeä¸­é‡è¯•";
            // å³ä½¿æ‘„åƒå¤´å¤±è´¥ï¼Œä¹Ÿè®©åŠ¨ç”»è·‘èµ·æ¥ï¼ˆè‡ªåŠ¨æ¼”ç¤ºæ¨¡å¼ï¼‰
            setInterval(() => {
                openness = (Math.sin(Date.now()/1000)+1)/2;
            }, 3000);
        }
    }

    function animate() {
        requestAnimationFrame(animate);
        
        const dt = clock.getElapsedTime();
        // ç¼“åŠ¨
        curOpen += (openness - curOpen) * 0.1;

        if(giftTree) {
            giftTree.rotation.y = dt * 0.2 + curOpen * 1.5;
            const s = 1 + curOpen * 0.2;
            giftTree.scale.set(s,s,s);
            if(star) {
                star.rotation.y -= 0.1;
                star.scale.setScalar(1 + Math.sin(dt*3)*0.2 + curOpen*0.5);
            }
        }

        // ç²’å­ä¼˜åŒ–ï¼šæ¯å¸§åªæ›´æ–°ä¸€éƒ¨åˆ†ï¼Œæˆ–è€…ç®€åŒ–è®¡ç®—
        if(particles) {
            const pPos = particles.geometry.attributes.position.array;
            const pVel = particles.geometry.attributes.velocity.array;
            
            // æ‰‹æœºä¸Šä¸ºäº†æ€§èƒ½ï¼Œç²’å­å¾ªç¯æ›´ç®€å•
            for(let i=0; i<pPos.length; i+=3) {
                const idx = i/3;
                pPos[i+1] += pVel[idx] * (1 + curOpen * 4); 
                if(pPos[i+1] > 30) pPos[i+1] = -10;
            }
            particles.geometry.attributes.position.needsUpdate = true;
        }

        const txt = document.getElementById('christmas-text');
        if(txt) {
            txt.style.opacity = curOpen > 0.5 ? 1 : 0;
            txt.style.transform = `translate(-50%, -50%) scale(${0.5 + curOpen * 0.8})`;
        }

        renderer.render(scene, camera);
    }
    
    // çª—å£è°ƒæ•´
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });
</script>
</body>
</html>
