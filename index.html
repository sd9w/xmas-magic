<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Christmas Magic Tree - Mobile</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        
        /* 启动遮罩层 - 适配手机点击授权 */
        #overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: #FFD700;
            text-align: center;
            padding: 20px;
        }
        #start-btn {
            padding: 15px 40px;
            font-size: 1.2rem;
            background: transparent;
            border: 2px solid #FFD700;
            color: #FFD700;
            border-radius: 30px;
            cursor: pointer;
            margin-top: 20px;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }

        #canvas-container { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; }
        
        /* 视频流处理：静默播放，防止 iOS 弹窗 */
        #video-input {
            position: absolute;
            width: 1px; height: 1px;
            opacity: 0;
            pointer-events: none;
        }

        #status-pill {
            position: absolute;
            top: env(safe-area-inset-top, 20px); /* 适配刘海屏 */
            left: 50%;
            transform: translateX(-50%);
            padding: 6px 12px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 20px;
            color: #FFD700;
            font-size: 12px;
            z-index: 10;
            white-space: nowrap;
        }

        #christmas-text {
            position: absolute;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.5);
            font-size: 2.5rem;
            font-weight: 900;
            color: #FFD700;
            text-shadow: 0 0 20px #FFD700;
            z-index: 5;
            opacity: 0;
            transition: all 0.4s ease-out;
            pointer-events: none;
            width: 100%;
            text-align: center;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <div id="overlay">
        <h2>Christmas Magic</h2>
        <p>需要摄像头权限以开启手势魔法</p>
        <button id="start-btn">开启魔法</button>
    </div>

    <div id="status-pill">等待初始化...</div>
    <h1 id="christmas-text">MERRY CHRISTMAS</h1>
    <video id="video-input" playsinline webkit-playsinline></video>
    <div id="canvas-container"></div>

<script>
    const CONFIG = {
        particleCount: window.innerWidth < 600 ? 3000 : 6000, // 手机减少粒子数保帧率
        treeLevels: 9,
        boxSize: 0.6
    };

    let scene, camera, renderer, giftTreeGroup, starMesh, starGlow, particleSystem;
    let openness = 0, currentOpenness = 0;

    // 适配手机点击启动
    document.getElementById('start-btn').addEventListener('click', function() {
        document.getElementById('overlay').style.display = 'none';
        initThreeJS();
        startCameraApp();
        animate();
    });

    function initThreeJS() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000000);
        
        camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 5, 20); // 手机端视角稍远一点
        camera.lookAt(0, 2, 0);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const ambient = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambient);
        const dirLight = new THREE.DirectionalLight(0xffd700, 1);
        dirLight.position.set(5, 15, 5);
        scene.add(dirLight);

        createGiftTree();
        createParticles();

        window.addEventListener('resize', onWindowResize);
    }

    function createGiftTree() {
        giftTreeGroup = new THREE.Group();
        const colors = [0xB22222, 0x006400, 0xFFFFFF, 0xDAA520];
        const materials = colors.map(c => new THREE.MeshStandardMaterial({ color: c, roughness: 0.5 }));
        const geom = new THREE.BoxGeometry(1, 1, 1);

        let y = 0;
        for(let i=0; i<CONFIG.treeLevels; i++) {
            const p = i/CONFIG.treeLevels;
            const r = 3.5 * (1-p) + 0.1;
            const s = CONFIG.boxSize * (1 - p*0.3);
            const count = Math.max(1, Math.floor((2*Math.PI*r)/(s*1.4)));
            
            for(let j=0; j<count; j++) {
                const ang = (j/count)*Math.PI*2 + i*0.5;
                const box = new THREE.Mesh(geom, materials[Math.floor(Math.random()*materials.length)]);
                box.position.set(Math.cos(ang)*r, y, Math.sin(ang)*r);
                box.rotation.set(Math.random(), ang, 0);
                box.scale.setScalar(s);
                giftTreeGroup.add(box);
            }
            y += s * 0.9;
        }

        // 星星
        const starGeo = new THREE.OctahedronGeometry(0.7, 0);
        starMesh = new THREE.Mesh(starGeo, new THREE.MeshBasicMaterial({ color: 0xFFFF00 }));
        starMesh.position.y = y;
        giftTreeGroup.add(starMesh);
        
        giftTreeGroup.position.y = -y/2;
        scene.add(giftTreeGroup);
    }

    function createParticles() {
        const geom = new THREE.BufferGeometry();
        const pos = [];
        const vels = [];
        for(let i=0; i<CONFIG.particleCount; i++) {
            pos.push((Math.random()-0.5)*100, (Math.random()-0.5)*60, (Math.random()-0.5)*60);
            vels.push(Math.random());
        }
        geom.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
        geom.setAttribute('velocity', new THREE.Float32BufferAttribute(vels, 1));
        const mat = new THREE.PointsMaterial({ color: 0xFFD700, size: 0.3, transparent: true, opacity: 0.6 });
        particleSystem = new THREE.Points(geom, mat);
        scene.add(particleSystem);
    }

    async function startCameraApp() {
        const videoElement = document.getElementById('video-input');
        const statusPill = document.getElementById('status-pill');

        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 0, // 手机端设为0以提高性能
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        hands.onResults((results) => {
            if(results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const lm = results.multiHandLandmarks[0];
                const dist = Math.hypot(lm[4].x - lm[8].x, lm[4].y - lm[8].y);
                openness = Math.max(0, Math.min(1, (dist - 0.05) * 5));
                statusPill.innerText = "✨ 魔法感应中";
            } else {
                openness = 0;
                statusPill.innerText = "请对着前置镜头张开手掌";
            }
        });

        // 适配手机：强制使用前置摄像头 (facingMode: 'user')
        const cameraObj = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 480, height: 640,
            facingMode: 'user' 
        });

        try {
            await cameraObj.start();
        } catch (err) {
            statusPill.innerText = "无法打开摄像头，请检查权限";
            console.error(err);
        }
    }

    function animate() {
        requestAnimationFrame(animate);
        currentOpenness += (openness - currentOpenness) * 0.1;
        const time = Date.now() * 0.001;

        if(giftTreeGroup) {
            giftTreeGroup.rotation.y = time * 0.3 + currentOpenness * 2;
            const s = 1 + currentOpenness * 0.2;
            giftTreeGroup.scale.set(s,s,s);
        }

        if(particleSystem) {
            const pos = particleSystem.geometry.attributes.position.array;
            const vels = particleSystem.geometry.attributes.velocity.array;
            for(let i=0; i<pos.length; i+=3) {
                pos[i+1] += (currentOpenness > 0.1) ? vels[i/3]*0.4 : -0.05;
                if(pos[i+1] < -30) pos[i+1] = 30;
                if(pos[i+1] > 30) pos[i+1] = -30;
            }
            particleSystem.geometry.attributes.position.needsUpdate = true;
        }

        const text = document.getElementById('christmas-text');
        text.style.opacity = currentOpenness > 0.7 ? 1 : 0;
        text.style.transform = `translate(-50%, -50%) scale(${0.5 + currentOpenness * 0.5})`;

        renderer.render(scene, camera);
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }
</script>
</body>
</html>
