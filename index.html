<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Magic Christmas Photo</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: sans-serif; touch-action: none; }
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, #1a1a1a 0%, #000 100%);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 100; color: #FFD700; transition: opacity 0.5s;
        }
        #start-btn {
            padding: 15px 40px; font-size: 1.2rem; background: rgba(255,215,0,0.1);
            border: 2px solid #FFD700; color: #FFD700; border-radius: 30px;
            cursor: pointer; box-shadow: 0 0 20px rgba(255,215,0,0.3);
            -webkit-tap-highlight-color: transparent;
        }
        #status-pill {
            position: absolute; top: 80px; left: 50%; transform: translateX(-50%);
            padding: 6px 14px; background: rgba(0,0,0,0.6); border-radius: 20px;
            color: #FFD700; font-size: 12px; z-index: 10; backdrop-filter: blur(4px);
            border: 1px solid rgba(255,215,0,0.3);
            white-space: nowrap;
        }
        #title-text {
            position: absolute; top: 15%; left: 50%; transform: translate(-50%, -50%);
            font-size: 2.5rem; font-weight: 900; color: #FFD700; z-index: 5;
            text-shadow: 0 0 20px #FFD700; opacity: 0; pointer-events: none;
            transition: opacity 0.5s; text-align: center; letter-spacing: 2px;
        }
        #video-input { position: absolute; width: 1px; height: 1px; opacity: 0; pointer-events: none; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <div id="overlay">
        <h1 style="font-size: 1.8rem; margin-bottom: 10px; color:#FFD700">åœ£è¯è®°å¿†é­”æ³•</h1>
        <p style="opacity: 0.8; margin-bottom: 30px; font-size: 0.9rem;">å¼ å¼€æ‰‹æŒï¼Œé‡Šæ”¾æ˜Ÿå…‰</p>
        <button id="start-btn">å¼€å¯é­”æ³•ç›¸æ¡†</button>
    </div>

    <div id="status-pill">ğŸ“¸ å‡†å¤‡ç›¸æœºä¸­...</div>
    <div id="title-text">MERRY<br>CHRISTMAS</div>
    <video id="video-input" playsinline webkit-playsinline></video>

<script>
    // --- æ‰‹æœºæ€§èƒ½é…ç½® ---
    const isMobile = window.innerWidth < 768;
    const CONFIG = {
        pCount: isMobile ? 1500 : 4000, // ç²’å­æ•°é‡
        starColor: 0xffd700,
        frameColor: 0xffaa00
    };

    let scene, camera, renderer, photoGroup, particles;
    let clock = new THREE.Clock();
    let openness = 0, curOpen = 0;

    document.getElementById('start-btn').onclick = function() {
        const btn = this;
        btn.innerText = "å¯åŠ¨ä¸­...";
        setTimeout(() => {
            document.getElementById('overlay').style.opacity = '0';
            setTimeout(() => document.getElementById('overlay').style.display = 'none', 500);
            initThree();
            startAI(); 
            animate();
        }, 100);
    };

    function initThree() {
        scene = new THREE.Scene();
        // é»‘è‰²èƒŒæ™¯ï¼Œå¸¦ä¸€ç‚¹ç‚¹é›¾æ°”å¢åŠ æ·±é‚ƒæ„Ÿ
        scene.fog = new THREE.FogExp2(0x000000, 0.05);

        camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.z = 18;

        renderer = new THREE.WebGLRenderer({ antialias: !isMobile, alpha: true });
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const amb = new THREE.AmbientLight(0xffffff, 0.8);
        scene.add(amb);
        const point = new THREE.PointLight(0xffd700, 2, 50);
        point.position.set(0, 5, 10);
        scene.add(point);

        createPhotoFrame();
        createParticles();
    }

    // --- åˆ›å»ºä¸­å¤®ç›¸æ¡† ---
    function createPhotoFrame() {
        photoGroup = new THREE.Group();

        // 1. é‡‘è‰²è¾¹æ¡†
        const frameGeo = new THREE.BoxGeometry(7.2, 7.2, 0.5);
        const frameMat = new THREE.MeshStandardMaterial({ 
            color: CONFIG.frameColor, roughness: 0.2, metalness: 0.8 
        });
        const frame = new THREE.Mesh(frameGeo, frameMat);
        photoGroup.add(frame);

        // 2. ç…§ç‰‡åŒºåŸŸ (è¿™é‡Œç”¨é¢œè‰²ä»£æ›¿ï¼Œä½ å¯ä»¥æ›¿æ¢ map: texture)
        // å¦‚æœä½ æœ‰ç…§ç‰‡é“¾æ¥ï¼Œå¯ä»¥å–æ¶ˆæ³¨é‡Šä¸‹é¢ä¸¤è¡Œï¼Œå¹¶å¡«å…¥ url
        // const loader = new THREE.TextureLoader();
        // const photoTexture = loader.load('ä½ çš„ç…§ç‰‡é“¾æ¥.jpg'); 
        
        const photoGeo = new THREE.PlaneGeometry(6.5, 6.5);
        const photoMat = new THREE.MeshBasicMaterial({ 
            color: 0xffffff, // é»˜è®¤ç™½è‰²åº•
            // map: photoTexture // å¦‚æœæœ‰ç…§ç‰‡ï¼Œå¯ç”¨è¿™è¡Œ
        });

        // ç®€å•çš„â€œçŒ«å’ªâ€å ä½ç¬¦ (ç”¨ Canvas åŠ¨æ€ç”»ä¸€ä¸ª)
        const canvas = document.createElement('canvas');
        canvas.width = 256; canvas.height = 256;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#f0f0f0'; ctx.fillRect(0,0,256,256);
        ctx.fillStyle = '#ff5555'; ctx.font = '40px Arial'; 
        ctx.textAlign = 'center'; ctx.fillText('Your Photo', 128, 120);
        ctx.fillText('Here', 128, 160);
        const defTex = new THREE.CanvasTexture(canvas);
        photoMat.map = defTex;

        const photo = new THREE.Mesh(photoGeo, photoMat);
        photo.position.z = 0.3; // ç¨å¾®å‡¸å‡ºä¸€ç‚¹
        photoGroup.add(photo);

        scene.add(photoGroup);
    }

    // --- åˆ›å»ºç²’å­æ˜Ÿå°˜ ---
    function createParticles() {
        const geo = new THREE.BufferGeometry();
        const pos = [], vels = [], sizes = [];
        
        for(let i=0; i<CONFIG.pCount; i++) {
            // åˆå§‹è®©ç²’å­å›´æˆä¸€ä¸ªåœˆ
            const r = 4 + Math.random() * 5;
            const theta = Math.random() * Math.PI * 2;
            const phi = (Math.random() - 0.5) * Math.PI;
            
            pos.push(r * Math.cos(theta) * Math.cos(phi), 
                     r * Math.sin(phi), 
                     r * Math.sin(theta) * Math.cos(phi));
            
            // é€Ÿåº¦å‘é‡ (å‘å¤–çˆ†ç‚¸çš„æ–¹å‘)
            vels.push((Math.random()-0.5), (Math.random()-0.5), (Math.random()-0.5));
            sizes.push(Math.random());
        }
        
        geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
        geo.setAttribute('velocity', new THREE.Float32BufferAttribute(vels, 3));
        geo.setAttribute('size', new THREE.Float32BufferAttribute(sizes, 1));

        // ç²’å­æè´¨
        const mat = new THREE.PointsMaterial({ 
            color: CONFIG.starColor, 
            size: 0.4, 
            transparent: true, 
            opacity: 0.8,
            blending: THREE.AdditiveBlending 
        });
        
        particles = new THREE.Points(geo, mat);
        scene.add(particles);
    }

    async function startAI() {
        const status = document.getElementById('status-pill');
        try {
            const hands = new Hands({
                locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
            });
            
            // ä¿æŒ Lite æ¨¡å‹ä»¥é˜²æ‰‹æœºå¡æ­»
            hands.setOptions({ maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.5 });
            
            hands.onResults(res => {
                if(res.multiHandLandmarks.length > 0) {
                    status.innerText = "âœ¨ æ‰‹åŠ¿è¯†åˆ«æˆåŠŸ";
                    const lm = res.multiHandLandmarks[0];
                    // è®¡ç®—é£ŸæŒ‡å’Œå¤§æ‹‡æŒ‡æŒ‡å°–è·ç¦»ï¼Œæˆ–è€…æ‰‹æŒå±•å¼€ç¨‹åº¦
                    const d = Math.hypot(lm[4].x-lm[8].x, lm[4].y-lm[8].y);
                    // æ”¾å¤§ç³»æ•°ï¼Œè®©äº’åŠ¨æ›´çµæ•
                    openness = Math.min(1, d * 6); 
                } else {
                    status.innerText = "ğŸ‘‹ è¯·åœ¨æ‘„åƒå¤´å‰å¼ å¼€æ‰‹";
                    openness = 0; // æ²¡æ‰‹æ—¶å½’é›¶
                }
            });

            const vid = document.getElementById('video-input');
            const cam = new Camera(vid, {
                onFrame: async () => await hands.send({image: vid}),
                width: isMobile ? 360 : 640, height: isMobile ? 270 : 480,
                facingMode: 'user'
            });
            await cam.start();
            status.innerText = "ğŸŒŸ é­”æ³•å·²å°±ç»ª";
            
        } catch(e) {
            console.error(e);
            status.innerText = "âš ï¸ æ‘„åƒå¤´æƒé™æœªå¼€å¯";
        }
    }

    function animate() {
        requestAnimationFrame(animate);
        const dt = clock.getElapsedTime();
        curOpen += (openness - curOpen) * 0.1; // ç¼“åŠ¨æ’å€¼

        // 1. ç›¸æ¡†åŠ¨ç”»ï¼šæ‰‹å¼ å¼€æ—¶ï¼Œç›¸æ¡†å˜å¤§å¹¶æ—‹è½¬
        if(photoGroup) {
            const scale = 1 + curOpen * 0.3; // æœ€å¤§æ”¾å¤§1.3å€
            photoGroup.scale.set(scale, scale, scale);
            // ç¼“æ…¢è‡ªè½¬ + æ‰‹åŠ¿åŠ é€Ÿæ—‹è½¬
            photoGroup.rotation.y = Math.sin(dt * 0.5) * 0.2 + curOpen * 0.5;
            photoGroup.rotation.z = Math.cos(dt * 0.3) * 0.1;
        }

        // 2. ç²’å­åŠ¨ç”»ï¼šæ‰‹å¼ å¼€æ—¶ï¼Œç²’å­æ‰©æ•£ï¼ˆçˆ†ç‚¸æ•ˆæœï¼‰
        if(particles) {
            const pos = particles.geometry.attributes.position.array;
            const vel = particles.geometry.attributes.velocity.array;
            // å¤‡ä»½ä¸€ä»½åŸå§‹ä½ç½®ç”¨äºå¤ä½
            if(!particles.geometry.attributes.initialPos) {
                 particles.geometry.attributes.initialPos = particles.geometry.attributes.position.clone();
            }
            const initPos = particles.geometry.attributes.initialPos.array;

            for(let i=0; i<pos.length; i+=3) {
                // åŸºç¡€æ¼‚æµ®
                const floatSpeed = 0.05 + curOpen * 0.2; // æ‰‹å¼ å¼€ï¼Œæ¼‚æµ®å˜å¿«
                
                // ç›®æ ‡ä½ç½® = åŸå§‹ä½ç½® + (é€Ÿåº¦å‘é‡ * å¼ å¼€ç¨‹åº¦ * çˆ†ç‚¸åŠå¾„)
                // è¿™é‡Œæ¨¡æ‹Ÿç²’å­è¢«â€œç‚¸â€å¼€çš„æ•ˆæœ
                const explodeFactor = curOpen * 15; // çˆ†ç‚¸åŠå¾„
                
                // ç®€å•çš„æ’å€¼åŠ¨ç”»ï¼šå½“å‰ä½ç½®è¶‹å‘äº (åŸå§‹ä½ç½® + åç§»)
                const tx = initPos[i] + vel[i] * explodeFactor;
                const ty = initPos[i+1] + vel[i+1] * explodeFactor;
                const tz = initPos[i+2] + vel[i+2] * explodeFactor;

                // åŠ ä¸Šä¸€ç‚¹æ—‹è½¬åŠ¨æ•ˆ
                pos[i] += (tx - pos[i]) * 0.1;
                pos[i+1] += (ty - pos[i+1]) * 0.1;
                pos[i+2] += (tz - pos[i+2]) * 0.1;
                
                // è®©æ•´ä½“ç¨å¾®æ—‹è½¬
                const x = pos[i], z = pos[i+2];
                const rotSpeed = 0.005 + curOpen * 0.02;
                pos[i] = x * Math.cos(rotSpeed) - z * Math.sin(rotSpeed);
                pos[i+2] = x * Math.sin(rotSpeed) + z * Math.cos(rotSpeed);
            }
            particles.geometry.attributes.position.needsUpdate = true;
        }

        // 3. æ–‡å­—åŠ¨ç”»
        const title = document.getElementById('title-text');
        if(title) {
            title.style.opacity = curOpen > 0.3 ? 1 : 0;
            title.style.transform = `translate(-50%, -50%) scale(${1 + curOpen * 0.5})`;
        }

        renderer.render(scene, camera);
    }
    
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });
</script>
</body>
</html>
