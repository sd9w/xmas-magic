<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Magic Christmas 2024</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: sans-serif; }
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, #1a1a1a 0%, #000 100%);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 100; color: #FFD700; transition: opacity 0.5s;
        }
        #start-btn {
            padding: 15px 40px; font-size: 1.2rem; background: rgba(255,215,0,0.1);
            border: 2px solid #FFD700; color: #FFD700; border-radius: 30px;
            cursor: pointer; box-shadow: 0 0 20px rgba(255,215,0,0.3);
        }
        #status-pill {
            position: absolute; top: 40px; left: 50%; transform: translateX(-50%);
            padding: 8px 16px; background: rgba(0,0,0,0.5); border-radius: 20px;
            color: #FFD700; font-size: 13px; z-index: 10; backdrop-filter: blur(5px);
            border: 1px solid rgba(255,215,0,0.2);
        }
        #christmas-text {
            position: absolute; top: 25%; left: 50%; transform: translate(-50%, -50%);
            font-size: 3rem; font-weight: 900; color: #FFD700; z-index: 5;
            text-shadow: 0 0 30px #FFD700; opacity: 0; pointer-events: none;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #video-input { position: absolute; width: 1px; height: 1px; opacity: 0; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/@mediapipe/hands/hands.js"></script>
</head>
<body>

    <div id="overlay">
        <h1 style="font-size: 2rem; margin-bottom: 10px;">åœ£è¯æ‰‹åŠ¿é­”æ³•</h1>
        <p style="opacity: 0.8; margin-bottom: 30px;">å¼ å¼€æ‰‹æŒï¼Œç‚¹äº®å¥‡è¿¹</p>
        <button id="start-btn">å¼€å¯é­”æ³•</button>
    </div>

    <div id="status-pill">ğŸ“¡ æ­£åœ¨è¿æ¥é­”æ³•æº...</div>
    <h1 id="christmas-text">MERRY<br>CHRISTMAS</h1>
    <video id="video-input" playsinline webkit-playsinline></video>
    <div id="canvas-container"></div>

<script>
    // --- å…¨å±€é…ç½® ---
    const CONFIG = {
        pCount: window.innerWidth < 600 ? 4000 : 8000,
        treeColor: 0x006400,
        starColor: 0xffd700
    };

    let scene, camera, renderer, giftTree, star, particles, clock = new THREE.Clock();
    let openness = 0, curOpen = 0;

    document.getElementById('start-btn').onclick = function() {
        document.getElementById('overlay').style.opacity = '0';
        setTimeout(() => document.getElementById('overlay').style.display = 'none', 500);
        init();
        startAI();
        animate();
    };

    function init() {
        scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000000, 0.03);

        camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.set(0, 6, 22);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // ç¯å…‰
        const amb = new THREE.AmbientLight(0xffffff, 0.4);
        scene.add(amb);
        const point = new THREE.PointLight(0xffd700, 2, 50);
        point.position.set(0, 10, 5);
        scene.add(point);

        createTree();
        createParticles();
    }

    function createTree() {
        giftTree = new THREE.Group();
        const colors = [0xff0000, 0x00ff00, 0xffffff, 0xffd700];
        const geom = new THREE.BoxGeometry(1, 1, 1);
        
        for(let i=0; i<12; i++) {
            const h = i * 0.9;
            const rad = 5 * (1 - i/12) + 0.2;
            const count = Math.floor(rad * 4) + 2;
            for(let j=0; j<count; j++) {
                const ang = (j/count) * Math.PI * 2 + i;
                const mat = new THREE.MeshStandardMaterial({ 
                    color: colors[Math.floor(Math.random()*colors.length)],
                    roughness: 0.3, metalness: 0.5
                });
                const box = new THREE.Mesh(geom, mat);
                box.position.set(Math.cos(ang)*rad, h, Math.sin(ang)*rad);
                box.rotation.set(Math.random(), ang, 0);
                box.scale.setScalar(0.6 * (1-i/15));
                giftTree.add(box);
            }
        }

        // ç‚«é…·æµå…‰æ˜Ÿ
        const sGeo = new THREE.OctahedronGeometry(1, 0);
        const sMat = new THREE.MeshBasicMaterial({ color: 0xfff000 });
        star = new THREE.Mesh(sGeo, sMat);
        star.position.y = 11;
        
        const glow = new THREE.PointLight(0xffd700, 5, 20);
        star.add(glow);
        giftTree.add(star);

        giftTree.position.y = -5;
        scene.add(giftTree);
    }

    function createParticles() {
        const geo = new THREE.BufferGeometry();
        const pos = [], vels = [];
        for(let i=0; i<CONFIG.pCount; i++) {
            pos.push((Math.random()-0.5)*80, Math.random()*40, (Math.random()-0.5)*80);
            vels.push(Math.random() * 0.2 + 0.05);
        }
        geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
        geo.setAttribute('velocity', new THREE.Float32BufferAttribute(vels, 1));
        const mat = new THREE.PointsMaterial({ color: 0xffd700, size: 0.2, transparent: true, blending: THREE.AdditiveBlending });
        particles = new THREE.Points(geo, mat);
        scene.add(particles);
    }

    async function startAI() {
        const status = document.getElementById('status-pill');
        const hands = new Hands({
            locateFile: (file) => `https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/@mediapipe/hands/${file}`
        });

        hands.setOptions({ maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.5 });
        hands.onResults(res => {
            if(res.multiHandLandmarks.length > 0) {
                status.innerText = "ğŸŒŸ é­”æ³•ç”Ÿæ•ˆä¸­";
                const lm = res.multiHandLandmarks[0];
                const d = Math.hypot(lm[4].x-lm[8].x, lm[4].y-lm[8].y);
                openness = Math.min(1, d * 4);
            } else {
                status.innerText = "ğŸ‘‹ è¯·å¼ å¼€æ‰‹æŒ";
                openness = 0;
            }
        });

        const cam = new Camera(document.getElementById('video-input'), {
            onFrame: async () => await hands.send({image: document.getElementById('video-input')}),
            width: 480, height: 640, facingMode: 'user'
        });
        
        try {
            await cam.start();
            status.innerText = "âœ¨ æ­£åœ¨å”¤é†’æ˜Ÿå…‰...";
        } catch(e) {
            status.innerText = "âŒ æ‘„åƒå¤´å¯åŠ¨å¤±è´¥";
        }
    }

    function animate() {
        requestAnimationFrame(animate);
        const dt = clock.getElapsedTime();
        curOpen += (openness - curOpen) * 0.1;

        // æ ‘ä¸æ˜Ÿæ—‹è½¬
        if(giftTree) {
            giftTree.rotation.y = dt * 0.2 + curOpen * 1.5;
            const s = 1 + curOpen * 0.2;
            giftTree.scale.set(s,s,s);
            star.rotation.y -= 0.1;
            star.scale.setScalar(1 + Math.sin(dt*5)*0.2 + curOpen*0.5);
        }

        // èºæ—‹ç²’å­æµ
        const pPos = particles.geometry.attributes.position.array;
        const pVel = particles.geometry.attributes.velocity.array;
        for(let i=0; i<pPos.length; i+=3) {
            const idx = i/3;
            pPos[i+1] += pVel[idx] * (1 + curOpen * 5); // éšæ‰‹åŠ¿åŠ é€Ÿå‡å¤©
            if(pPos[i+1] > 30) pPos[i+1] = -10;
            pPos[i] += Math.sin(dt + idx) * 0.05;
        }
        particles.geometry.attributes.position.needsUpdate = true;

        // æ–‡å­—äº’åŠ¨
        const txt = document.getElementById('christmas-text');
        txt.style.opacity = curOpen > 0.6 ? (curOpen - 0.6) * 2.5 : 0;
        txt.style.transform = `translate(-50%, -50%) scale(${0.5 + curOpen * 0.8})`;

        renderer.render(scene, camera);
    }
</script>
</body>
</html>
